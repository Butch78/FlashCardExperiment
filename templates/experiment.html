<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{{title}}</title>
    <!-- Requires jQuery -->
    <script src="{{ url_for('static', filename='js/jquery.min.js')}}" type="text/javascript"></script>

    <link rel="stylesheet" media="all" href="{{ url_for('static', filename='css/style.css')}}" />
</head>

<body>

    <div>
        <p>
        <h1>Instructions</h1>
        </p>
        <p>We are now going to show you the LLM Generated FlashCards. The source Text is Highlighted on the left, the
            Generated FlashCard is on the right</p>
        <p>For the scientific validity of this experiment, it is vital that the review task is taken <b>very
                seriously</b>.
        </p>
        <ul>
            <li>Like in real life, you should <b>find as many defects as possible</b> and you should <b>spend as little
                    time
                    as possible</b> on the review.</li>
            <li>Unlike in real life, we are <b>not interested in maintainability or design issues</b>, but only in
                correctness issues ("bugs").</li>
        </ul>

        <p>For example, a remark like the following is beyond the goal of the review: "Create a new class which is
            implemented by runnable interface that we can access multiple times."
            Instead, what we are interested in are the defects that make the code not work as intended under all
            circumstances.</p>

        <p>Please assume that the code compiles and that the tests pass.</p>
        <p>
            To add a review remark, click on the corresponding line number. To delete a review mark, click on it again
            and
            delete the remark's text.<br><br>
        </p>

    </div>


    {% from "macros.html" import render_flashcard %}
    <style>
        .container {
            display: flex;
            height: 50vh;
            /* Adjust based on your layout */
        }

        .pdf-viewer {
            flex: 2;
            /* Adjust based on your preference */
            height: 100%;
        }

        .sidebar {
            flex: 2;
            /* Adjust based on your preference */
            background-color: #f0f0f0;
            /* Example background color */
            padding: 20px;
            overflow-y: auto;
            /* Allows scrolling if the content is too long */
        }

        .flashcard {
            border: 1px solid #ccc;
            /* Example border */
            padding: 10px;
            margin-top: 20px;
        }

        .front,
        .back {
            margin-bottom: 10px;
        }
    </style>



    <div id="flashcards-container">
        {% for flashcard in flashcards %}
        <div class="flashcard-container" id="flashcard-{{ loop.index }}" style="display: none;">
            <div class="cards">
                <div class="container">
                    <div class="pdf-viewer">
                        <iframe src="/pdfs/{{ flashcard.file_name }}" width="100%" height="600px" loading="lazy"
                            title="PDF-file"></iframe>
                    </div>
                    <div class="sidebar">
                        <h2>{{ flashcard.section_heading }}</h2>
                        <div class="flashcard">
                            <div class="front">
                                <h3>Front</h3>
                                <p>{{ flashcard.front }}</p>
                            </div>
                            <div class="back">
                                <h3>Back</h3>
                                <p>{{ flashcard.back }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="questions">
                <form action="experiment" method="post" id="current_form">
                    <fieldset class="container_radio_buttons">
                        <p> How relevant is the Above created Flashcard to the Content?</p>
                        <label><input type="radio" name="{{flashcard.file_name}}-relevance-" value="1" required> 1 (Not
                            relevant at all)</label>
                        <label><input type="radio" name="{{flashcard.file_name}}-relevance" value="2"> 2</label>
                        <label><input type="radio" name="{{flashcard.file_name}}-relevance" value="3"> 3</label>
                        <label><input type="radio" name="{{flashcard.file_name}}-relevance" value="4"> 4</label>
                        <label><input type="radio" name="{{flashcard.file_name}}-relevance" value="5"> 5 (Extremely
                            relevant)</label>

                        <p>How comprehensive is the created Flashcard on the Right? </p>
                        <label><input type="radio" name="{{flashcard.file_name}}-comprehensive" value="1" required>
                            1 (Not at all comprehensive)</label>
                        <label><input type="radio" name="{{flashcard.file_name}}-comprehensive" value="2"> 2</label>
                        <label><input type="radio" name="{{flashcard.file_name}}-comprehensive" value="3"> 3</label>
                        <label><input type="radio" name="{{flashcard.file_name}}-comprehensive" value="4"> 4</label>
                        <label><input type="radio" name="{{flashcard.file_name}}-comprehensive" value="5"> 5 (Extremely
                            comprehensive)</label>

                        <p>How accurate is the the create FlashCard on the Right? </p>
                        <label><input type="radio" name="{{flashcard.file_name}}-accuracy" value="1" required> 1 (Not
                            accurate)</label>
                        <label><input type="radio" name="{{flashcard.file_name}}-accuracy" value="2"> 2</label>
                        <label><input type="radio" name="{{flashcard.file_name}}-accuracy" value="3"> 3</label>
                        <label><input type="radio" name="{{flashcard.file_name}}-accuracy" value="4"> 4</label>
                        <label><input type="radio" name="{{flashcard.file_name}}-accuracy" value="5"> 5 (Extremely
                            accurate)</label>
                        <br>
                        <p> Loop Index: {{loop.index}} </p>
                        <button type="button" onclick="showNextFlashcard({{loop.index}})" class="button blue">Submit &
                            Next</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>

    <script>

        async function submitResponses() {
            // Create a FormData object
            var formData = new FormData();

            // Add all responses from localStorage to formData
            for (var i = 0; i < localStorage.length; i++) {
                var key = localStorage.key(i);
                var value = localStorage.getItem(key);
                formData.append(key, value);
            }


            // Send the form data
            try {
                const response = await fetch('/results', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error:', error);
                return;
            }

            // Clear localStorage
            localStorage.clear();

            // Redirect to a completion page or show a completion message
            window.location.href = '/conclusion';
        }


        document.addEventListener('DOMContentLoaded', (event) => {
            // Attempt to retrieve the current index from localStorage, defaulting to 1 if not found
            let currentIndex = parseInt(localStorage.getItem('currentIndex') || '1');

            // Display the current flashcard based on the retrieved or default index
            let currentCard = document.getElementById('flashcard-' + currentIndex);
            if (currentCard) {
                currentCard.style.display = 'block';
            } else {
                // If no current card is found, show the first flashcard and reset currentIndex to 1
                document.getElementById('flashcard-1').style.display = 'block';
                localStorage.setItem('currentIndex', '1');
            }
        });

        function saveResponses(index) {
            let flashcard = document.getElementById('flashcard-' + index);
            if (!flashcard) return;

            let inputs = flashcard.querySelectorAll('input[type="radio"]');
            inputs.forEach(input => {
                if (input.checked) {
                    localStorage.setItem(input.name + '-' + index, input.value);
                }
            });
        }

        async function showNextFlashcard(currentIndex) {

            saveResponses(currentIndex);

            // Hide the current flashcard
            let currentCard = document.getElementById('flashcard-' + currentIndex);
            if (currentCard) {
                currentCard.style.display = 'none';
            }

            // Increment the currentIndex and update localStorage
            let nextIndex = currentIndex + 1;
            localStorage.setItem('currentIndex', nextIndex.toString());

            // Attempt to show the next flashcard
            let nextCard = document.getElementById('flashcard-' + nextIndex);
            if (nextCard) {
                nextCard.style.display = 'block';
            } else {
                // If there is no next flashcard, perform completion actions
                document.cookie = "experiment-is_done=DONE; path=/";
                submitResponses(); // Adjust this function as needed
                // Consider resetting or clearing the currentIndex in localStorage after completion
                localStorage.removeItem('currentIndex');
            }
        }

        // Ensure your existing submitResponses function or any form submission logic 
        // appropriately prevents default submission if necessary and calls this function.

    </script>
</body>

</html>